---
import { NAVIGATION } from "../data/constants";
import { BookingModal } from "./react/Modals";

const currentPath = Astro.url.pathname;

function isActive(href: string): boolean {
  if (href === "/") return currentPath === "/";
  return currentPath === href || currentPath.startsWith(href.split("#")[0] + "/") || currentPath === href.split("#")[0];
}
---

<header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60" role="banner">
  <div class="max-w-7xl mx-auto flex h-16 items-center justify-between px-4 sm:px-6 lg:px-8">
    <!-- Logo -->
    <a href="/" class="flex items-center space-x-2 mr-6" title="Unicalibre Estimating - Home">
      <span class="font-heading font-bold text-xl sm:text-2xl tracking-tight text-slate-900">
        Uni<span class="text-primary">Calibre</span>
      </span>
      <span class="hidden sm:inline-block text-xs font-semibold tracking-wider text-slate-500 uppercase mt-1">Estimating</span>
    </a>

    <!-- Desktop Navigation -->
    <nav class="hidden md:flex flex-1 items-center justify-center gap-1" aria-label="Main navigation">
      {NAVIGATION.map((item) => (
        <div class="relative group">
          {item.children ? (
            <>
              <a
                href={item.href}
                class:list={[
                  "inline-flex items-center gap-1 px-4 py-2 rounded-md text-sm font-medium transition-colors",
                  isActive(item.href)
                    ? "text-primary font-semibold"
                    : "text-slate-600 hover:bg-slate-100 hover:text-slate-900"
                ]}
                aria-haspopup="true"
                aria-expanded="false"
              >
                {item.label}
                <svg class="w-3.5 h-3.5 opacity-60 transition-transform group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7"/></svg>
              </a>
              <!-- Dropdown -->
              <div class="invisible group-hover:visible group-focus-within:visible opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-all duration-200 absolute top-full left-1/2 -translate-x-1/2 pt-2 z-50" role="menu">
                <div class="bg-white border border-slate-200 rounded-lg shadow-lg p-4 min-w-[280px]">
                  {item.label === "Services" ? (
                    <ul class="grid grid-cols-2 gap-1">
                      {item.children.map((child) => (
                        <li role="none">
                          <a href={child.href} class="block px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-primary transition-colors" role="menuitem">
                            {child.label}
                          </a>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <ul class="space-y-1">
                      {item.children.map((child) => (
                        <li role="none">
                          <a href={child.href} class="block px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-primary transition-colors" role="menuitem">
                            {child.label}
                          </a>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </div>
            </>
          ) : (
            <a
              href={item.href}
              class:list={[
                "px-4 py-2 rounded-md text-sm font-medium transition-colors",
                isActive(item.href)
                  ? "text-primary font-semibold bg-primary/5"
                  : "text-slate-600 hover:bg-slate-100 hover:text-slate-900"
              ]}
            >
              {item.label}
            </a>
          )}
        </div>
      ))}
    </nav>

    <!-- Desktop CTA -->
    <div class="hidden md:flex items-center space-x-4">
      <BookingModal client:load />
    </div>

    <!-- Mobile menu button -->
    <button
      type="button"
      class="md:hidden inline-flex items-center justify-center rounded-md p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900"
      id="mobile-menu-button"
      aria-expanded="false"
      aria-controls="mobile-menu"
      aria-label="Toggle navigation menu"
    >
      <span class="sr-only">Open main menu</span>
      <svg class="h-6 w-6" id="menu-icon-open" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
      </svg>
      <svg class="h-6 w-6 hidden" id="menu-icon-close" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Mobile menu -->
  <nav class="hidden md:hidden border-t border-slate-100" id="mobile-menu" aria-label="Mobile navigation">
    <div class="px-4 pb-6 pt-4 space-y-2 max-h-[80vh] overflow-y-auto">
      {NAVIGATION.map((item) => (
        <>
          {item.children ? (
            <div class="py-2">
              <h4 class="font-semibold text-slate-900 mb-2 px-3">{item.label}</h4>
              <div class="pl-4 space-y-1 border-l-2 border-slate-100">
                {item.children.map((child) => (
                  <a
                    href={child.href}
                    class:list={[
                      "block text-sm py-1.5 px-3 rounded-md transition-colors",
                      isActive(child.href)
                        ? "text-primary font-semibold"
                        : "text-slate-500 hover:text-primary"
                    ]}
                  >
                    {child.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <a
              href={item.href}
              class:list={[
                "block font-medium py-2.5 px-3 rounded-md border-b border-slate-100 last:border-0 transition-colors",
                isActive(item.href)
                  ? "text-primary font-semibold"
                  : "text-slate-600 hover:text-primary"
              ]}
            >
              {item.label}
            </a>
          )}
        </>
      ))}
      <div class="pt-4">
        <a
          href="/contact"
          class="block px-4 py-3 bg-primary text-primary-foreground text-center font-semibold rounded-lg"
        >
          Contact Us
        </a>
      </div>
    </div>
  </nav>
</header>

<script>
  const button = document.getElementById("mobile-menu-button");
  const menu = document.getElementById("mobile-menu");
  const iconOpen = document.getElementById("menu-icon-open");
  const iconClose = document.getElementById("menu-icon-close");

  button?.addEventListener("click", () => {
    const expanded = button.getAttribute("aria-expanded") === "true";
    button.setAttribute("aria-expanded", (!expanded).toString());
    menu?.classList.toggle("hidden");
    iconOpen?.classList.toggle("hidden");
    iconClose?.classList.toggle("hidden");
  });
</script>
