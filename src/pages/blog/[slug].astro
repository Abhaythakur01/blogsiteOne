---
import Layout from "../../layouts/Layout.astro";
import PortableText from "../../components/blog/PortableText";
import { getPosts, getPost, urlFor } from "../../lib/sanity";
import { formatDate, calculateReadingTime } from "../../lib/utils";
import type { PortableTextBlock } from "@portabletext/types";

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post: any) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await getPost(slug as string);

if (!post) {
  return Astro.redirect("/404");
}

const ogImage = post.seo?.ogImage
  ? urlFor(post.seo.ogImage).width(1200).height(630).url()
  : post.mainImage
    ? urlFor(post.mainImage).width(1200).height(630).url()
    : undefined;

// Calculate reading time from body text
let readingTime = 0;
if (post.body) {
  const textContent = post.body
    .filter((block: PortableTextBlock) => block._type === "block")
    .map((block: PortableTextBlock) =>
      (block.children as any[])?.map((child: any) => child.text).join("") || ""
    )
    .join(" ");
  readingTime = calculateReadingTime(textContent);
}

// BreadcrumbList structured data
const breadcrumbData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": new URL("/", Astro.site).href,
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": new URL("/blog", Astro.site).href,
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": post.title,
      "item": Astro.url.href,
    },
  ],
};
---

<Layout
  title={post.seo?.metaTitle || post.title}
  description={post.seo?.metaDescription || post.excerpt}
  ogImage={ogImage}
  type="article"
  publishedTime={post.publishedAt}
  author={post.author?.name}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} slot="head" />

  <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header -->
    <header class="max-w-3xl mx-auto mb-12">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
        <a href="/" class="hover:text-primary transition-colors">Home</a>
        <span>/</span>
        <a href="/blog" class="hover:text-primary transition-colors">Blog</a>
        <span>/</span>
        <span class="text-slate-700 truncate">{post.title}</span>
      </nav>

      {post.categories && post.categories.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-4">
          {post.categories.map((category: any) => (
            <a
              href={`/categories/${category.slug.current}`}
              class="text-xs font-semibold uppercase tracking-wider px-3 py-1 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors"
            >
              {category.title}
            </a>
          ))}
        </div>
      )}

      <h1 class="text-4xl md:text-5xl font-heading font-bold text-slate-900 mb-6">{post.title}</h1>

      {post.excerpt && (
        <p class="text-xl text-slate-600 mb-8">{post.excerpt}</p>
      )}

      <div class="flex items-center gap-4 text-slate-500">
        {post.author && (
          <div class="flex items-center gap-3">
            {post.author.image && (
              <img
                src={urlFor(post.author.image).width(48).height(48).url()}
                alt={post.author.name}
                class="w-12 h-12 rounded-full object-cover ring-2 ring-slate-100"
              />
            )}
            <div>
              <p class="font-medium text-slate-900">{post.author.name}</p>
              <div class="flex items-center gap-2 text-sm">
                <time datetime={post.publishedAt}>
                  {formatDate(post.publishedAt)}
                </time>
                {readingTime > 0 && (
                  <>
                    <span>&middot;</span>
                    <span>{readingTime} min read</span>
                  </>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    </header>

    <!-- Featured Image -->
    {post.mainImage && (
      <figure class="max-w-4xl mx-auto mb-12">
        <img
          src={urlFor(post.mainImage).width(1200).height(675).url()}
          alt={post.mainImage.alt || post.title}
          class="w-full rounded-2xl shadow-lg"
        />
      </figure>
    )}

    <!-- Content -->
    <div class="max-w-3xl mx-auto prose">
      <PortableText value={post.body} client:load />
    </div>

    <!-- Author Bio -->
    {post.author?.bio && (
      <aside class="max-w-3xl mx-auto mt-16 glass-panel rounded-2xl p-8">
        <div class="flex items-start gap-5">
          {post.author.image && (
            <img
              src={urlFor(post.author.image).width(80).height(80).url()}
              alt={post.author.name}
              class="w-20 h-20 rounded-full object-cover flex-shrink-0 ring-4 ring-primary/10"
            />
          )}
          <div>
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-400 mb-1">About the Author</p>
            <h3 class="font-heading font-bold text-lg text-slate-900 mb-2">{post.author.name}</h3>
            <div class="text-slate-600 text-sm">
              <PortableText value={post.author.bio} client:load />
            </div>
          </div>
        </div>
      </aside>
    )}

    <!-- Back to Blog -->
    <div class="max-w-3xl mx-auto mt-12">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-primary hover:text-primary/80 font-medium transition-colors"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Blog
      </a>
    </div>
  </article>
</Layout>
