---
import Layout from "../../layouts/Layout.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import { getCategories, getPostsByCategory, sanityClient } from "../../lib/sanity";

export async function getStaticPaths() {
  const categories = await getCategories();
  return categories.map((category: any) => ({
    params: { slug: category.slug.current },
  }));
}

const { slug } = Astro.params;

const category = await sanityClient.fetch(
  `*[_type == "category" && slug.current == $slug][0]`,
  { slug }
);

if (!category) {
  return Astro.redirect("/404");
}

const posts = await getPostsByCategory(slug as string);
---

<Layout
  title={category.title}
  description={category.description || `Browse all posts in ${category.title}`}
>
  <!-- Hero -->
  <section class="py-24 bg-slate-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-2xl">
        <a
          href="/categories"
          class="inline-flex items-center gap-2 text-slate-500 hover:text-primary mb-4 transition-colors"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          All Categories
        </a>
        <h1 class="mb-4 text-slate-900">{category.title}</h1>
        {category.description && (
          <p class="text-xl text-slate-600">
            {category.description}
          </p>
        )}
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    {posts.length > 0 ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {posts.map((post: any) => (
          <BlogCard post={post} />
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-slate-500 text-lg">No posts in this category yet.</p>
        <a href="/blog" class="text-primary hover:text-primary/80 mt-4 inline-block font-medium">
          Browse all posts &rarr;
        </a>
      </div>
    )}
  </section>
</Layout>
