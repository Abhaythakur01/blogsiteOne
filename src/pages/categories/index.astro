---
import Layout from "../../layouts/Layout.astro";
import { getCategories, sanityClient } from "../../lib/sanity";
import { getCategoryColors } from "../../lib/utils";

const categories = await getCategories();

// Get post count for each category
const categoriesWithCount = await Promise.all(
  categories.map(async (category: any) => {
    const count = await sanityClient.fetch(
      `count(*[_type == "post" && $categoryId in categories[]._ref])`,
      { categoryId: category._id }
    );
    return { ...category, postCount: count };
  })
);
---

<Layout
  title="Categories"
  description="Browse blog posts by category."
>
  <!-- Hero -->
  <section class="py-24 bg-slate-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-2xl">
        <p class="text-primary font-semibold uppercase tracking-wider text-sm mb-3">Browse Topics</p>
        <h1 class="mb-4 text-slate-900">Categories</h1>
        <p class="text-xl text-slate-600">
          Browse posts by topic to find exactly what you're looking for.
        </p>
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    {categoriesWithCount.length > 0 ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {categoriesWithCount.map((category) => {
          const colors = getCategoryColors(category.color);
          return (
          <a
            href={`/categories/${category.slug.current}`}
            class="group bg-white p-8 rounded-xl border border-slate-100 shadow-sm hover:border-primary/20 hover:shadow-md transition-all"
          >
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-heading font-bold text-slate-900 group-hover:text-primary transition-colors">
                {category.title}
              </h2>
              <span
                class:list={[
                  "text-sm font-semibold rounded-full px-3 py-1",
                  !colors && "bg-primary/10 text-primary"
                ]}
                style={colors ? `background-color: ${colors.bg}; color: ${colors.text};` : undefined}
              >
                {category.postCount}
              </span>
            </div>
            {category.description && (
              <p class="text-slate-600 line-clamp-2">
                {category.description}
              </p>
            )}
          </a>
          );
        })}
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-slate-500 text-lg">No categories yet.</p>
      </div>
    )}
  </section>
</Layout>
